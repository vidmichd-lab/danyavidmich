---
import BaseLayout from "@layouts/BaseLayout.astro";
import Header from "@components/Header.astro";
import "@styles/home.css";
import { getCases, type CaseEntry } from "@utils/casesStore";
import { getCaseTag } from "@utils/caseTags";
import { generateSrcSet, getOptimizedImagePath } from "@utils/imageUtils";

import { getOGMeta } from "@utils/ogMeta";

const ogMeta = await getOGMeta("");
const title = ogMeta.title;
const description = ogMeta.description;
const cases = await getCases();
const heroCase = cases.find((entry) => entry.isHero) ?? cases[0];
const otherCases = heroCase
  ? cases.filter((entry) => entry.id !== heroCase.id)
  : cases;
const heroTag = heroCase ? getCaseTag(heroCase.tag) : null;
const resolveLink = (entry: CaseEntry | undefined) => {
  if (!entry) return undefined;
  const linkValue =
    typeof entry.linkUrl === "string" ? entry.linkUrl : `/${entry.slug}`;
  if (!linkValue) return undefined;
  const trimmed = linkValue.trim();
  if (trimmed.length === 0) return undefined;
  if (/^https?:\/\//i.test(trimmed)) {
    return trimmed;
  }
  if (trimmed.startsWith("/") && trimmed.endsWith(".html")) {
    const withoutHtml = trimmed.slice(0, -5);
    return withoutHtml.endsWith("/") ? withoutHtml : `${withoutHtml}/`;
  }
  if (trimmed.startsWith("/") && !trimmed.endsWith("/")) {
    return `${trimmed}/`;
  }
  return trimmed;
};
const heroLink = resolveLink(heroCase);
const otherCasesWithMeta = otherCases.map((entry) => ({
  entry,
  tag: getCaseTag(entry.tag),
  link: resolveLink(entry)
}));
type CaseWithMeta = (typeof otherCasesWithMeta)[number];

const COLUMN_COUNT = 3;
const caseColumns: Array<Array<CaseWithMeta>> = Array.from(
  { length: COLUMN_COUNT },
  () => [] as Array<CaseWithMeta>
);

// Distribute cases with perfect balance for mobile (columns 0 and 1)
// Strategy: distribute evenly between columns 0 and 1, then move every 3rd to column 2
// This ensures columns 0 and 1 are always balanced for mobile view
otherCasesWithMeta.forEach((item, idx) => {
  // Calculate which column this item should go to
  // Items at indices 2, 5, 8... (every 3rd starting from 2) go to column 2
  // All others alternate between columns 0 and 1
  if ((idx + 1) % 3 === 0) {
    // Every 3rd item goes to column 2 for desktop
    caseColumns[2].push(item);
  } else {
    // Calculate the position in the sequence of items that stay in columns 0 and 1
    // For items 0, 1, 3, 4, 6, 7... we need to alternate between 0 and 1
    const positionInMobileColumns = idx - Math.floor(idx / 3);
    const mobileColumn = positionInMobileColumns % 2;
    caseColumns[mobileColumn].push(item);
  }
});

// Add hero case to balance the first two columns for mobile
if (heroCase) {
  const heroMeta = {
    entry: heroCase,
    tag: heroTag ?? getCaseTag(heroCase.tag),
    link: heroLink
  } as CaseWithMeta;
  const col0Count = caseColumns[0].length;
  const col1Count = caseColumns[1].length;
  // Add hero to the shorter column to maintain perfect mobile balance
  if (col0Count <= col1Count) {
  caseColumns[0].unshift(heroMeta);
  } else {
    caseColumns[1].unshift(heroMeta);
  }
}

type ExtraMediaItem = {
  src?: string;
  alt?: string;
  link?: string;
  title?: string;
  description?: string;
  tagId?: import("@utils/casesStore").CaseTag;
  loading?: "lazy" | "eager";
  iframeSrc?: string;
  iframeAllow?: string;
  iframeStyle?: string;
  caption?: string;
};

const getExtraMediaTag = (tagId?: import("@utils/casesStore").CaseTag) =>
  tagId ? getCaseTag(tagId) : null;

const isIframeItem = (
  item: ExtraMediaItem
): item is ExtraMediaItem & { iframeSrc: string } =>
  typeof item.iframeSrc === "string" && item.iframeSrc.length > 0;

// All posters - will be distributed randomly across columns
const allPosters: ExtraMediaItem[] = [
  {
    src: "/img/gr/posters/2/2f86f7238425827.6914766d6d3cb.webp",
    alt: "Poster artwork"
  },
  {
    src: "/img/gr/posters/2/3.webp",
    alt: "Poster 3"
  },
  {
    src: "/img/gr/posters/2/4.webp",
    alt: "Poster 4"
  },
  {
    src: "/img/gr/posters/2/5.webp",
    alt: "Poster 5"
  },
  {
    src: "/img/gr/posters/2/6.webp",
    alt: "Poster 6"
  },
  {
    src: "/img/gr/posters/2/7.webp",
    alt: "Poster 7"
  },
  {
    src: "/img/gr/posters/2/8.webp",
    alt: "Poster 8"
  },
  {
    src: "/img/gr/posters/2/2/111bba231472727.6889e1ae12aaa.png",
    alt: "Poster artwork"
  },
  {
    src: "/img/gr/posters/2/2/3.png",
    alt: "Poster 3"
  }
];

// Shuffle posters array for random distribution
const shuffledPosters = [...allPosters].sort(() => Math.random() - 0.5);

// Distribute shuffled posters across 3 columns
const postersByColumn: Array<ExtraMediaItem[]> = [[], [], []];
shuffledPosters.forEach((poster, idx) => {
  const columnIndex = idx % 3;
  postersByColumn[columnIndex].push(poster);
});

const columnExtras: ReadonlyArray<ReadonlyArray<ExtraMediaItem>> = [
  [
    {
      src: "/img/gr/po1.webp",
      alt: "Poster collage"
    },
    {
      src: "/img/gr/po2.webp",
      alt: "Poster collage variant"
    },
    {
      src: "/img/gr/rublev/cover.gif",
      alt: "Rublev typeface cover",
      link: "/rublev.html",
      title: "Rublev",
      tagId: "typography"
    },
    {
      src: "/img/gr/Frame%2029.webp",
      alt: "Frame poster"
    },
    {
      src: "/img/gr/Frame%203%20Large.webp",
      alt: "Frame poster alternate"
    },
    ...postersByColumn[0]
  ],
  [
    {
      src: "/img/gr/po4.webp",
      alt: "Poster artwork"
    },
    {
      src: "/img/gr/po3.webp",
      alt: "Poster artwork variant"
    },
    {
      src: "/img/gr/01234.webp",
      alt: "01234 typography poster"
    },
    {
      src: "/img/gr/po5.webp",
      alt: "Poster graphic"
    },
    {
      src: "/img/gr/signs.webp",
      alt: "Wayfinding signs"
    },
    {
      src: "/img/other/chess.webp",
      alt: "Chess poster"
    },
    {
      src: "/img/gr/fop.webp",
      alt: "Poster collage"
    },
    ...postersByColumn[1]
  ],
  [
    {
      src: "/img/gr/cubes3.webp",
      alt: "Cubes poster"
    },
    {
      src: "/img/other/poster2.webp",
      alt: "Poster artwork"
    },
    {
      iframeSrc:
        "https://player.vimeo.com/video/714391101?h=f94ebefed7&autoplay=1&loop=1&title=0&byline=0&portrait=0&muted=1",
      iframeAllow: "autoplay; fullscreen; picture-in-picture",
      iframeStyle: "top:0;left:0;width:100%;height:100%;",
      title: "Temp School Promo"
    },
    {
      src: "/img/other/ach.webp",
      alt: "ACH poster"
    },
    {
      src: "/img/other/window.webp",
      alt: "Window poster"
    },
    {
      src: "/img/other/go.webp",
      alt: "Yandex Go poster"
    },
    {
      src: "/img/other/budu.webp",
      alt: "Budu poster"
    },
    {
      src: "/img/gr/swan.webp",
      alt: "Save the swan poster"
    },
    {
      src: "/img/gr/igla.gif",
      alt: "Igla motion poster"
    },
    ...postersByColumn[2]
  ]
] as const;

type ColumnItem =
  | {
      kind: "case";
      entry: CaseWithMeta["entry"];
      tag: CaseWithMeta["tag"];
      link: CaseWithMeta["link"];
    }
  | {
      kind: "case-secondary";
      entry: CaseWithMeta["entry"];
    }
  | {
      kind: "media";
      media: ExtraMediaItem;
    };

const buildColumnItems = (
  caseItems: CaseWithMeta[],
  extras: ReadonlyArray<ExtraMediaItem>
): ColumnItem[] => {
  if (caseItems.length === 0) {
    return extras.map((media) => ({
      kind: "media",
      media
    }));
  }

  const result: ColumnItem[] = [];
  const totalCases = caseItems.length;
  const totalExtras = extras.length;
  const step =
    totalExtras > 0 ? Math.max(1, Math.round(totalCases / totalExtras)) : 0;
  let extraIndex = 0;
  let caseCounter = step;

  caseItems.forEach((item) => {
    result.push({
      kind: "case",
      entry: item.entry,
      tag: item.tag,
      link: item.link
    });

    if (item.entry.layout === "double" && item.entry.secondaryImage) {
      result.push({
        kind: "case-secondary",
        entry: item.entry
      });
    }

    if (totalExtras > 0) {
      caseCounter -= 1;
      if (caseCounter <= 0 && extraIndex < totalExtras) {
        result.push({
          kind: "media",
          media: extras[extraIndex++]
        });
        caseCounter = step;
      }
    }
  });

  while (extraIndex < totalExtras) {
    result.push({
      kind: "media",
      media: extras[extraIndex++]
    });
  }

  return result;
};

const displayColumns = caseColumns.map((caseItems, columnIndex) =>
  buildColumnItems(caseItems, columnExtras[columnIndex] ?? [])
);
---

<BaseLayout
  {title}
  {description}
  ogTitle={ogMeta.ogTitle}
  ogDescription={ogMeta.ogDescription}
  ogUrl={ogMeta.ogUrl}
  ogImage={ogMeta.ogImage}
>
  <Fragment slot="head">
    {/* Preload hero image for faster LCP - critical for mobile performance */}
    {heroCase && (
      <link rel="preload" as="image" href={getOptimizedImagePath(heroCase.coverImage)} />
    )}
    
    {/* Defer external connections - only preconnect, don't load scripts immediately */}
    <link rel="dns-prefetch" href="https://player.vimeo.com" />
    <link rel="dns-prefetch" href="https://www.googletagmanager.com" />
    <link rel="dns-prefetch" href="https://mc.yandex.ru" />
    
    {/* Load analytics only after page is interactive - critical for mobile performance */}
    <script is:inline>
      // Defer all analytics to after page load
      if ('requestIdleCallback' in window) {
        requestIdleCallback(() => {
          // Google Analytics
          const gtagScript = document.createElement('script');
          gtagScript.async = true;
          gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-4LGZW7QNFB';
          document.head.appendChild(gtagScript);
          
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-4LGZW7QNFB');
          
          // Yandex Metrika
          (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
          m[i].l=1*new Date();
          for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
          k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
          (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
          
          ym(93372850, "init", {
              clickmap:true,
              trackLinks:true,
              accurateTrackBounce:true,
              webvisor:true
          });
        }, { timeout: 5000 });
      } else {
        window.addEventListener('load', () => {
          setTimeout(() => {
            // Google Analytics
            const gtagScript = document.createElement('script');
            gtagScript.async = true;
            gtagScript.src = 'https://www.googletagmanager.com/gtag/js?id=G-4LGZW7QNFB';
            document.head.appendChild(gtagScript);
            
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-4LGZW7QNFB');
            
            // Yandex Metrika
      (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
      m[i].l=1*new Date();
      for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
      k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
      (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

      ym(93372850, "init", {
          clickmap:true,
          trackLinks:true,
          accurateTrackBounce:true,
          webvisor:true
      });
          }, 2000);
        });
      }
    </script>
    
    {/* Vimeo player - load only when needed */}
    <script is:inline defer src="https://player.vimeo.com/api/player.js" onerror="this.onerror=null;"></script>
  </Fragment>

  <noscript>
    <div class="sr-only">
      <img src="https://mc.yandex.ru/watch/93372850" alt="" width="1" height="1" />
    </div>
  </noscript>

  <Header variant="home" subtitle="Projects" />

  <div class="main">
    <div class="about">
      <div>
        <div>
          <p>
            Multidisciplinary designer. Ex Badoo, Yandex Music, Yandex Go and
            <a href="https://www.artlebedev.ru/vidmich/">Art. Lebedev Studio</a>. Co-founded dating app
Apt.
            Type creator. Making media
            <a href="https://instagram.com/lugmedia/">Lug</a>
          </p>
        </div>
      </div>

      <div class="action-group desktop-only">
        <button class="circle-button" onclick="window.location.href='/cv/'" aria-label="Open CV page">
          <span aria-hidden="true" class="circle-button__text">CV</span>
          <span class="sr-only">Open CV Page</span>
        </button>

        <button class="circle-button" onclick="window.location.href='mailto:mail@danyavidmich.com'" aria-label="Get in touch by email">
          <span aria-hidden="true" class="circle-button__icon tabler--mail-filled"></span>
          <span class="sr-only">Get in touch</span>
        </button>

        <span class="avatar-wrapper">
          <img 
            class="avatar" 
            src="/avatar.jpg" 
            alt="Danya Vidmich" 
            width="64"
            height="64"
            loading="lazy"
            decoding="async"
            onerror="this.onerror=null; this.style.display='none';"
          />
        </span>
      </div>
    </div>

    <div class="aboutzero"></div>

    <div class="mobile-filters-actions">
      <div class="action-group">
        <button class="circle-button" onclick="window.location.href='/cv/'" aria-label="Open CV page">
          <span aria-hidden="true" class="circle-button__text">CV</span>
          <span class="sr-only">Open CV Page</span>
        </button>

        <button class="circle-button" onclick="window.location.href='mailto:mail@danyavidmich.com'" aria-label="Get in touch by email">
          <span aria-hidden="true" class="circle-button__icon tabler--mail-filled"></span>
          <span class="sr-only">Get in touch</span>
        </button>

        <span class="avatar-wrapper">
          <img 
            class="avatar" 
            src="/avatar.jpg" 
            alt="Danya Vidmich" 
            width="64"
            height="64"
            loading="lazy"
            decoding="async"
            onerror="this.onerror=null; this.style.display='none';"
          />
        </span>
      </div>
      <div class="portfolio-filters" id="portfolio-filters">
        <button class="filter-button filter-button--active" data-filter="all">All</button>
        <button class="filter-button" data-filter="branding">Branding</button>
        <button class="filter-button" data-filter="visual">Visual Communications</button>
        <button class="filter-button" data-filter="product">Product Design</button>
        <button class="filter-button" data-filter="web">Web</button>
        <button class="filter-button" data-filter="typography">Typography</button>
        <button class="filter-button" data-filter="merch">Merch</button>
        <button class="filter-button" data-filter="concept">Concept</button>
        <button class="filter-button" data-filter="posters">Posters</button>
      </div>
    </div>
    <section class="portfolio">
      <div class="portfolio-filters desktop-filters" id="portfolio-filters-desktop">
        <button class="filter-button filter-button--active" data-filter="all">All</button>
        <button class="filter-button" data-filter="branding">Branding</button>
        <button class="filter-button" data-filter="visual">Visual Communications</button>
        <button class="filter-button" data-filter="product">Product Design</button>
        <button class="filter-button" data-filter="web">Web</button>
        <button class="filter-button" data-filter="typography">Typography</button>
        <button class="filter-button" data-filter="merch">Merch</button>
        <button class="filter-button" data-filter="concept">Concept</button>
        <button class="filter-button" data-filter="posters">Posters</button>
      </div>
      <div class="portfolio__columns">
        {(() => {
          let caseIndex = 0;
          return displayColumns.map((columnItems) => (
            <div class="portfolio__column">
              {columnItems.map((item) => {
              if (item.kind === "media") {
                if (isIframeItem(item.media)) {
                  const allowValue =
                    typeof item.media.iframeAllow === "string"
                      ? item.media.iframeAllow
                      : "autoplay; fullscreen; picture-in-picture";
                  const styleValue =
                    typeof item.media.iframeStyle === "string"
                      ? item.media.iframeStyle
                      : "top:0;left:0;width:100%;height:100%;";
                  const iframeTag = item.media.tagId || "posters";
                  return (
                    <div class="bigcard" data-tag={iframeTag}>
                      <iframe
                        src={item.media.iframeSrc}
                        title={item.media.title ?? "Embedded media"}
                        loading="lazy"
                        style={`${styleValue}; border: 0;`}
                        allow={allowValue}
                        allowfullscreen
                        width="800"
                        height="450"
                      ></iframe>
                      {item.media.caption && <p>{item.media.caption}</p>}
                    </div>
                  );
                }

                const tag = getExtraMediaTag(item.media.tagId);
                const hasTitle = Boolean(item.media.title);
                const hasTag = Boolean(tag);
                // Check if this is a poster (from /posters/ folder) - don't show tags but use "posters" for filtering
                const isPoster = item.media.src?.includes('/posters/') || false;
                const mediaTag = isPoster ? "posters" : (item.media.tagId || "posters");
                // Don't show tags for posters
                const shouldShowTags = !isPoster && (hasTitle || hasTag);

                return (
                  <div class="bigcard" data-tag={mediaTag}>
                    {item.media.link ? (
                      <a href={item.media.link}>
                        <img
                          id="click"
                          src={item.media.src ? getOptimizedImagePath(item.media.src) : ""}
                          srcset={item.media.src && !item.media.src.toLowerCase().endsWith('.gif') && !item.media.src.includes('/img/gr/posters/') ? generateSrcSet(item.media.src) : undefined}
                          sizes="(max-width: 800px) 50vw, 33vw"
                          alt={item.media.alt ?? item.media.title ?? "Case image"}
                          loading={item.media.loading ?? "lazy"}
                          decoding="sync"
                          width="800"
                          height="450"
                          onerror='this.onerror=null;this.src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect width=%22800%22 height=%22600%22 fill=%22%23eaebec%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22 font-size=%2216%22%3EImage not available%3C/text%3E%3C/svg%3E";this.style.opacity="0.7";'
                        />
                      </a>
                    ) : (
                      <img
                        src={item.media.src ? getOptimizedImagePath(item.media.src) : ""}
                        srcset={item.media.src && !item.media.src.toLowerCase().endsWith('.gif') && !item.media.src.includes('/img/gr/posters/') ? generateSrcSet(item.media.src) : undefined}
                        sizes="(max-width: 800px) 50vw, 33vw"
                        alt={item.media.alt ?? item.media.title ?? "Case image"}
                        loading={item.media.loading ?? "lazy"}
                        decoding="sync"
                        width="800"
                        height="450"
                        onerror='this.onerror=null;this.src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect width=%22800%22 height=%22600%22 fill=%22%23eaebec%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22 font-size=%2216%22%3EImage not available%3C/text%3E%3C/svg%3E";this.style.opacity="0.7";'
                      />
                    )}
                    {shouldShowTags && (
                      <p>
                        {item.media.title ?? ""}
                        {tag && (
                          <span class={tag.className}>
                            {item.media.description ?? tag.label}
                            <span></span>
                          </span>
                        )}
                      </p>
                    )}
                    {item.media.caption && !shouldShowTags && (
                      <p>{item.media.caption}</p>
                    )}
                  </div>
                );
              }

              if (item.kind === "case-secondary") {
                return (
                  <div class="bigcard" data-tag={item.entry.tag}>
                    <img
                      src={getOptimizedImagePath(item.entry.secondaryImage ?? item.entry.coverImage)}
                      srcset={generateSrcSet(item.entry.secondaryImage ?? item.entry.coverImage)}
                      sizes="(max-width: 800px) 50vw, 33vw"
                      alt={
                        item.entry.coverImageAlt ??
                        `${item.entry.title} secondary`
                      }
                      loading="lazy"
                      decoding="async"
                      width="800"
                      height="450"
                    />
                  </div>
                );
              }

              const { entry, tag, link } = item;
              caseIndex++;
              // Only hero case loads eagerly, all others are lazy
              const fetchPriority = entry.isHero ? "high" : undefined;
              const loadingMode = entry.isHero ? "eager" : "lazy";

              return (
                <div class="bigcard" data-tag={entry.tag}>
                  {link ? (
                    <a href={link}>
                      <img
                        id="click"
                        src={getOptimizedImagePath(entry.coverImage)}
                        srcset={generateSrcSet(entry.coverImage)}
                        sizes="(max-width: 800px) 50vw, 33vw"
                        alt={entry.coverImageAlt ?? entry.title}
                        fetchpriority={fetchPriority}
                        loading={loadingMode}
                        decoding={entry.isHero ? "sync" : "async"}
                        width="800"
                        height="450"
                      />
                    </a>
                  ) : (
                    <img
                      src={getOptimizedImagePath(entry.coverImage)}
                      srcset={generateSrcSet(entry.coverImage)}
                      sizes="(max-width: 800px) 50vw, 33vw"
                      alt={entry.coverImageAlt ?? entry.title}
                      fetchpriority={fetchPriority}
                      loading={loadingMode}
                      decoding={entry.isHero ? "sync" : "async"}
                      width="800"
                      height="450"
                      onerror='this.onerror=null;this.src="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22800%22 height=%22600%22%3E%3Crect width=%22800%22 height=%22600%22 fill=%22%23eaebec%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22 font-family=%22Arial%22 font-size=%2216%22%3EImage not available%3C/text%3E%3C/svg%3E";this.style.opacity="0.7";'
                    />
                  )}
                  {link ? (
                    <a href={link}>
                      <p>
                        {entry.title}{" "}
                        {tag && entry.id !== "1913" && (entry.description || tag.label) && (
                          <span class={tag.className}>
                            {entry.description ?? tag.label}
                            <span></span>
                          </span>
                        )}
                      </p>
                    </a>
                  ) : (
                    <p>
                      {entry.title}{" "}
                      {tag && entry.id !== "1913" && (entry.description || tag.label) && (
                        <span class={tag.className}>
                          {entry.description ?? tag.label}
                          <span></span>
                        </span>
                      )}
                    </p>
                  )}
                </div>
              );
            })}
        </div>
          ))
        })()}
      </div>
    </section>
  </div>

  <div class="header">
    <div class="top">
      <a href="#" id="title1" data-scroll-to-top aria-label="Scroll to top" title="Go to top">Danya Vidmich</a>
      <p id="title2"></p>
      <p id="title3"></p>
      </div>
    </div>
    
  <link rel="stylesheet" href="/styles/portfolio-filters.css" />
  <script src="/scripts/portfolio-filters.js" defer></script>
</BaseLayout>

