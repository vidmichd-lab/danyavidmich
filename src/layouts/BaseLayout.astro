---
import "@styles/reset.css";
import "@styles/base.css";
import "@styles/global.css";

const {
  title = "Designer Danya Vidmich",
  description = "Graphic and product designer. Ex Badoo, Yandex Music, Yandex Go and Art. Lebedev Studio. Making media Lug. Co-founded dating app Apt",
  keywords = "graphic design, product design, Danya Vidmich, portfolio, designer, yandex go, yandex music, badoo, apt app, apt, vidmich, daniil vidmich, даня видмич, даниил видмич, видмич, дизайнер, арт-директор, art director, cv, studio, works, cases, identity, branding, web, mobile, merch",
  author = "Danya Vidmich",
  ogTitle = "Danya Vidmich. Graphic and product design",
  ogDescription = description,
  ogType = "website",
  ogUrl = import.meta.env.PUBLIC_SITE_URL || "https://danyavidmich.com",
  ogImage = `${import.meta.env.PUBLIC_SITE_URL || "https://danyavidmich.com"}/Union.png`,
  twitterCard = "summary_large_image",
  preloadFonts = true
} = Astro.props;
---

<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <meta name="author" content={author} />

    <meta property="og:type" content={ogType} />
    <meta property="og:title" content={ogTitle} />
    <meta property="og:description" content={ogDescription} />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={ogTitle} />

    <meta name="twitter:card" content={twitterCard} />
    <meta name="twitter:title" content={ogTitle} />
    <meta name="twitter:description" content={ogDescription} />
    <meta name="twitter:image" content={ogImage} />

    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="canonical" href={ogUrl} />
    
    {/* Preconnect to external resources */}
    <link rel="preconnect" href="https://player.vimeo.com" crossorigin />
    <link rel="dns-prefetch" href="https://mc.yandex.ru" />

    {/* Critical CSS - inline for faster rendering and preventing layout shift */}
    <style is:inline>
      {`*{box-sizing:border-box}body{margin:0;font-family:"Arial Narrow",Arial,system-ui,-apple-system,sans-serif;font-size:18px;line-height:1.1;color:#525252;background:#f9fafb;overflow-x:hidden}img{width:100%;height:auto;display:block}.header{position:fixed;top:0;left:0;right:0;z-index:1000;width:100%;height:44px;background:linear-gradient(180deg,#f9fafb 60%,rgba(241,241,241,0) 100%);font-size:18px}.main{display:flex;align-items:flex-start;justify-content:space-between;flex-direction:row;width:calc(100% - 24px);margin:44px auto 0}@media (max-width:800px){.header{height:64px;font-size:32px}.main{flex-direction:column;width:calc(100% - 24px);margin:64px auto 0}}`}
    </style>

    {preloadFonts && (
      <>
        {/* Preload critical font for mobile - only one to reduce blocking */}
        <link rel="preload" href="/fonts/arialnarrow.ttf" as="font" type="font/ttf" crossorigin="anonymous" />
      </>
    )}

    <slot name="head" />
    
    {/* JSON-LD structured data */}
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Danya Vidmich",
      "alternateName": "Daniil Vidmich",
      "jobTitle": "Multidisciplinary Design Lead",
      "description": description,
      "url": ogUrl,
      "sameAs": [
        "https://www.linkedin.com/in/vidmichd/",
        "https://t.me/dvtel"
      ],
      "knowsAbout": [
        "Graphic Design",
        "Product Design",
        "Brand Identity",
        "Digital Marketing",
        "UI/UX Design"
      ],
      "alumniOf": [
        {
          "@type": "Organization",
          "name": "Art. Lebedev Studio"
        }
      ],
      "worksFor": [
        {
          "@type": "Organization",
          "name": "Yandex Practicum"
        }
      ]
    })} />
  </head>
  <body>
    <slot />
    <script is:inline src="/javascript.js" defer></script>
    <script src="/scripts/image-error-handler.js" defer></script>
    <script is:inline>
      // Register service worker (deferred to not block page load)
      if ('serviceWorker' in navigator) {
        // Use requestIdleCallback if available, otherwise setTimeout
        const registerSW = () => {
          navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
            .then((registration) => {
              // Check for updates on focus (when user returns to tab)
        // This is more efficient than polling every hour
        window.addEventListener('focus', function() {
          registration.update();
        }, { once: false });
            })
            .catch(() => {
              // Service worker registration failed
            });
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(registerSW, { timeout: 5000 });
        } else {
          setTimeout(registerSW, 3000);
        }
      }
    </script>
    <script>
        // Initialize error tracking (only in production with DSN) - deferred
        if (import.meta.env.PUBLIC_SENTRY_DSN && import.meta.env.PROD) {
          const initSentryAsync = async () => {
            try {
              // Use dynamic import with proper path resolution
              const { initSentry } = await import('../utils/sentry.ts');
              await initSentry();
            } catch (error) {
              // Silently fail if Sentry can't be loaded
              // Only log in development (terser will remove this in production)
              if (import.meta.env.DEV) {
                // eslint-disable-next-line no-console
                console.warn('Sentry initialization failed:', error);
              }
            }
          };

          if ('requestIdleCallback' in window) {
            requestIdleCallback(initSentryAsync, { timeout: 5000 });
          } else {
            setTimeout(initSentryAsync, 3000);
          }
        }
    </script>
  </body>
</html>

